# Vault Alerts Anonymization Rules

**Version**: 1.0
**Last Updated**: 2025-10-13
**Owner**: Well Intake Development Team

---

## Table of Contents

1. [Overview](#overview)
2. [Why Anonymization](#why-anonymization)
3. [Anonymization Categories](#anonymization-categories)
4. [Implementation Architecture](#implementation-architecture)
5. [Compliance Verification](#compliance-verification)
6. [Testing](#testing)
7. [Deployment](#deployment)
8. [Troubleshooting](#troubleshooting)
9. [Maintenance](#maintenance)

---

## Overview

This document defines comprehensive anonymization rules for vault candidate alerts to ensure confidentiality compliance while maintaining candidate quality assessment. All vault alerts generated by the system must pass through multiple anonymization layers before being shared with clients.

**Core Principle**: Enable confident client sharing by preventing LinkedIn identification, BrokerCheck lookups, and firm-specific database searches.

### Anonymization Scope

- **In Scope**: Vault candidate alerts (advisors & executives), weekly digests, Teams bot responses
- **Out of Scope**: Internal CRM records, authenticated dashboard views, direct recruiter communications
- **Privacy Mode Toggle**: Controlled via `PRIVACY_MODE` environment variable (default: `true`)

---

## Why Anonymization

### Identification Risks

Without proper anonymization, candidates can be identified through:

1. **LinkedIn Search**: `[Job Title]` + `[Firm]` + `[Location]` + `[Years Experience]`
2. **BrokerCheck Lookup**: Exact AUM figures combined with firm name and location
3. **Firm Internal Databases**: Specific production numbers revealing individual advisors
4. **Public Recognition**: Awards, rankings, and achievements tied to specific firms

### Business Impact

**Without Anonymization**:
- Candidates withdraw due to privacy concerns
- Clients poach candidates directly, bypassing recruitment process
- Legal liability for confidentiality breaches
- Loss of competitive advantage

**With Anonymization**:
- Confident sharing with prospective employers
- Protected candidate pipeline integrity
- Compliance with confidentiality agreements
- Competitive intelligence protection

---

## Anonymization Categories

### 1. Firm Names

**Risk Level**: 🔴 **CRITICAL**

**Problem**: Firm name + location + title = LinkedIn identification

**Solution**: Replace with generic firm type classifications

#### Firm Type Mapping

| Original Firm | Anonymized Replacement | AUM-Based Refinement |
|---------------|------------------------|----------------------|
| **Wirehouses** |
| Merrill Lynch | Major wirehouse | - |
| Morgan Stanley | Major wirehouse | - |
| Wells Fargo Advisors | Major wirehouse | - |
| UBS | Major wirehouse | - |
| Raymond James | Large regional wirehouse | - |
| **RIAs** |
| Fisher Investments | Large RIA | AUM ≥ $1B → "Large RIA" |
| Edelman Financial | Large RIA | AUM < $1B → "Mid-sized RIA" |
| [Any RIA] | Mid-sized RIA / Large RIA | Based on parsed AUM |
| **Banks** |
| JPMorgan Private Bank | National bank | - |
| Bank of America Private Bank | National bank | - |
| Wells Fargo Private Bank | National bank | - |
| Citigroup Private Bank | National bank | - |
| **Insurance** |
| Northwestern Mutual | Insurance brokerage | - |
| MassMutual | Insurance brokerage | - |
| New York Life | Insurance brokerage | - |
| Prudential | Insurance brokerage | - |
| **Professional Services** |
| Deloitte | Major accounting firm | - |
| PwC | Major accounting firm | - |
| EY | Major accounting firm | - |
| KPMG | Major accounting firm | - |
| McKinsey | Management consulting firm | - |
| BCG | Management consulting firm | - |
| Bain | Management consulting firm | - |

#### Implementation

```python
# Location: app/jobs/talentwell_curator.py:651-688

def _anonymize_company(self, company_name: str, aum: Optional[float] = None) -> str:
    """
    Replace firm names with generic descriptors for privacy.
    Prevents candidate identification through company name.
    """
    if not company_name or company_name == "Unknown":
        return "Not disclosed"

    # Check against known firm types
    for firm_type, firms in self.FIRM_TYPE_MAP.items():
        if any(firm.lower() in company_name.lower() for firm in firms):
            if firm_type == 'wirehouse':
                return "Major wirehouse"
            elif firm_type == 'ria':
                # Use AUM to distinguish size if available
                if aum and aum > 1_000_000_000:  # $1B+
                    return "Large RIA"
                else:
                    return "Mid-sized RIA"
            elif firm_type == 'bank':
                return "National bank"
            # ... additional mappings

    # Generic fallback based on AUM
    if aum:
        if aum > 500_000_000:  # $500M+
            return "Large wealth management firm"
        else:
            return "Boutique advisory firm"

    return "Advisory firm"
```

#### Usage in Alerts

**Before Anonymization**:
```
Senior Advisor at Morgan Stanley - New York, NY
```

**After Anonymization**:
```
Senior Advisor at Major wirehouse - New York, NY
```

---

### 2. Financial Metrics

**Risk Level**: 🟠 **HIGH**

**Problem**: Exact AUM/production figures are fingerprints when combined with other data

**Solution**: Round to broad ranges with "+" suffix

#### AUM Rounding Rules

| Exact AUM | Rounded Range | Reasoning |
|-----------|---------------|-----------|
| $6.5B | $5B+ AUM | Billions rounded to nearest billion |
| $2.8B | $2B+ AUM | Prevents exact identification |
| $1.2B | $1B+ AUM | Clear tier distinction |
| $850M | $500M+ AUM | Hundred-million increments |
| $425M | $400M+ AUM | Protection for mid-sized books |
| $150M | $100M+ AUM | Smallest displayable range |
| <$100M | (suppressed) | Too identifying at small scale |

#### Implementation

```python
# Location: app/jobs/talentwell_curator.py:722-738

def _round_aum_for_privacy(self, aum_value: float) -> str:
    """
    Round AUM to broad ranges with + suffix for privacy.

    Examples: $1.5B → "$1B+ AUM", $750M → "$500M+ AUM"
    """
    if aum_value >= 1_000_000_000:  # $1B+
        billions = int(aum_value / 1_000_000_000)
        return f"${billions}B+ AUM"
    elif aum_value >= 100_000_000:  # $100M - $999M
        hundreds = int(aum_value / 100_000_000) * 100
        return f"${hundreds}M+ AUM"
    elif aum_value >= 10_000_000:  # $10M - $99M
        tens = int(aum_value / 10_000_000) * 10
        return f"${tens}M+ AUM"
    else:
        return ""  # Too small to display (identifying)
```

#### Production Metrics

**Before**: "Production: $1,250,000 annually"
**After**: "Production: $1M+ annually"

**Rounding Logic**:
- Values ≥ $1M: Round to nearest $100K
- Values < $1M but ≥ $500K: Display as "$500K+ production"
- Values < $500K: Suppress (too identifying)

#### Client Count Privacy

**Before**: "Manages 87 client relationships"
**After**: "Manages 80+ client relationships"

**Rounding Logic**:
- 100+: Round down to nearest 50 (e.g., 143 → "100+")
- 50-99: Round down to nearest 10 (e.g., 72 → "70+")
- <50: Round down to nearest 5 (e.g., 37 → "35+")

---

### 3. Locations

**Risk Level**: 🟡 **MEDIUM**

**Problem**: Small city + firm type = very narrow candidate pool

**Solution**: Normalize to major metropolitan areas (top 25 metros only)

#### Metro Area Normalization

| Original Location | Normalized Metro | Notes |
|-------------------|------------------|-------|
| **New York Region** |
| Manhattan, NY | New York, NY | Primary metro |
| Brooklyn, NY | New York, NY | Include boroughs |
| Jersey City, NJ | New York, NY | Metropolitan area |
| White Plains, NY | New York, NY | Suburban inclusion |
| **California** |
| San Francisco, CA | San Francisco, CA | Primary metro |
| Palo Alto, CA | San Francisco, CA | Bay Area consolidation |
| San Jose, CA | San Francisco, CA | Silicon Valley included |
| Los Angeles, CA | Los Angeles, CA | Primary metro |
| Orange County, CA | Los Angeles, CA | Southern CA consolidation |
| San Diego, CA | San Diego, CA | Keep as distinct metro |
| **Florida** |
| Miami, FL | Miami, FL | Primary metro |
| Fort Lauderdale, FL | Miami, FL | Tri-county area |
| West Palm Beach, FL | Miami, FL | Include for anonymity |
| Gulf Breeze, FL | Gulf Breeze (Pensacola area) | Small city notation |
| **Texas** |
| Dallas, TX | Dallas, TX | Primary metro |
| Fort Worth, TX | Dallas, TX | DFW consolidation |
| Plano, TX | Dallas, TX | Suburban inclusion |
| Houston, TX | Houston, TX | Primary metro |
| Austin, TX | Austin, TX | Primary metro |
| San Antonio, TX | San Antonio, TX | Primary metro |
| **Midwest** |
| Chicago, IL | Chicago, IL | Primary metro |
| Naperville, IL | Chicago, IL | Chicagoland area |
| Evanston, IL | Chicago, IL | North suburbs |

#### Implementation

```python
# Location: app/jobs/talentwell_curator.py:1650-1675

async def _normalize_location(self, location: str) -> str:
    """Normalize location to metro area using city_context.json."""
    if not location or location == "Unknown":
        return location

    # Load city context
    try:
        with open("app/policy/seed/city_context.json", "r") as f:
            city_context = json.load(f)
    except:
        logger.warning("Could not load city_context.json")
        return location

    # Normalize location for lookup
    location_key = location.lower().replace(" ", "_").replace(",", "")

    # Check for metro area mapping
    if location_key in city_context:
        metro = city_context[location_key]
        # Special handling for small cities like Gulf Breeze
        if "gulf_breeze" in location_key:
            return f"Gulf Breeze (Pensacola area)"
        return metro

    # Return original if no mapping found
    return location
```

#### Special Cases

**Very Small Cities** (population < 50K):
- Include regional context: "Gulf Breeze (Pensacola area)"
- Prevents over-identification in small markets

**International Locations**:
- Major cities only: "London, UK", "Toronto, Canada"
- Regional cities suppressed or noted: "Greater Toronto Area"

**Remote Candidates**:
- Location line: "Remote (open to nationwide opportunities)"
- Original location suppressed entirely

---

### 4. Education

**Risk Level**: 🟡 **MEDIUM**

**Problem**: University + graduation year + metro = LinkedIn profile match

**Solution**: Degree types only, no institutions or years

#### Education Anonymization Rules

| Original | Anonymized |
|----------|------------|
| MBA, Wharton '15 | MBA |
| BS Finance, NYU Stern '10 | Bachelor's degree in Finance |
| Harvard undergrad | Bachelor's degree |
| CFA Charter, passed 2018 | CFA charterholder |
| Northwestern JD/MBA dual | JD/MBA dual degree |

#### Implementation

**Suppress Identifying Details**:
- ❌ School names (Harvard, Wharton, MIT)
- ❌ Graduation years (Class of '15)
- ❌ Honors/distinctions (summa cum laude, top 10%)
- ✅ Degree types (MBA, BS Finance)
- ✅ Professional designations (CFA, CFP, CPA)

**Example Transformations**:

```python
# Input: "MBA from Wharton School of Business, Class of 2015"
# Output: "MBA"

# Input: "BS Economics, Harvard University (magna cum laude)"
# Output: "Bachelor's degree in Economics"

# Input: "JD/MBA dual degree from Northwestern University"
# Output: "JD/MBA dual degree"
```

---

### 5. Achievements

**Risk Level**: 🟠 **HIGH**

**Problem**: Unique performance markers (awards, rankings) are searchable

**Solution**: Generalize to achievement categories without specific names

#### Achievement Generalization

| Specific Achievement | Generalized Version |
|---------------------|---------------------|
| President's Club 2023 | Top-tier recognition club |
| Barron's Top 100 Advisor | National industry ranking |
| #1 Producer, Miami Branch | Top producer at branch |
| Morgan Stanley Chairman's Club | Elite performance recognition |
| Forbes Best-in-State 2024 | State-level industry recognition |
| MDRT Court of the Table | Elite industry association membership |

#### Implementation Guidelines

**Allowed**:
- ✅ "Top 1% performer nationally"
- ✅ "Elite production club member"
- ✅ "Recognized for growth achievements"
- ✅ "Industry association leadership"

**Prohibited**:
- ❌ Specific award names ("President's Club")
- ❌ Ranking publications ("Barron's Top 100")
- ❌ Firm-specific programs ("Chairman's Club")
- ❌ Exact rankings ("#1 producer")

---

### 6. Proprietary Systems & Programs

**Risk Level**: 🟡 **MEDIUM**

**Problem**: Firm-specific program names reveal employer

**Solution**: Neutral descriptions of training/development

#### System Name Anonymization

| Proprietary Name | Neutral Description |
|------------------|---------------------|
| Morgan Stanley PBIG | Private banking group experience |
| Merrill Lynch Thunder Program | Advanced training program |
| UBS Wealth Advisor Development | Advisor development program |
| Goldman Sachs PWM Certification | Private wealth certification |
| RBC Wealth Academy | Comprehensive training program |

#### Implementation

**Detection Pattern**:
```python
proprietary_patterns = [
    r'(morgan stanley|merrill lynch|ubs|goldman|rbc)\s+[\w\s]+\s+(program|academy|certification)',
    r'(pbig|thunder|wealth academy)',
    # ... additional patterns
]
```

**Replacement Logic**:
- Training programs → "Advanced training program"
- Certifications → "Specialized certification program"
- Development tracks → "Career development program"
- Technology platforms → "Proprietary technology platform"

---

### 7. Licenses & Designations

**Risk Level**: 🟢 **LOW**

**Problem**: Minimal risk, but avoid exact license dates

**Solution**: List licenses without dates or jurisdictions

#### License Formatting

**Allowed**:
- ✅ "Series 7, 66, 65"
- ✅ "CFA charterholder"
- ✅ "CFP®, CPA"
- ✅ "State insurance licenses"

**Prohibited**:
- ❌ "Series 7 (obtained 2015)"
- ❌ "Licensed in New York and New Jersey"
- ❌ "CFA passed all 3 levels consecutively in 2018-2020"
- ❌ "Pending Series 24 (exam scheduled March 2025)"

#### Implementation

```python
def anonymize_licenses(license_text: str) -> str:
    """Remove dates and jurisdictions from license listings."""
    # Remove dates: (2015), obtained 2020, passed 2018
    text = re.sub(r'\(?\b(19|20)\d{2}\b\)?', '', license_text)

    # Remove jurisdictions: in New York, NY licensed, state of California
    text = re.sub(r'\bin\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?', '', text)

    # Clean up extra whitespace
    text = re.sub(r'\s+', ' ', text).strip()

    return text
```

---

### 8. Compensation

**Risk Level**: 🟡 **MEDIUM**

**Problem**: Exact compensation expectations can narrow candidate pool

**Solution**: Standardized OTE format with ranges

#### Strict Compensation Format

**Standard Format**: `Target comp: $XXK–$YYK OTE`

**Transformation Examples**:

| Raw Input | Standardized Output |
|-----------|---------------------|
| 95k + commission | Target comp: $95K OTE |
| $750k all in | Target comp: $750K OTE |
| 200-250k base + bonus | Target comp: $200K–$250K OTE |
| 95k base + commission 140+ OTE | Target comp: $95K–$140K OTE |
| $1.5M total compensation | Target comp: $1500K OTE |
| negotiable | Target comp: Negotiable |

#### Implementation

```python
# Location: app/jobs/talentwell_curator.py:740-794

def _standardize_compensation(self, raw_text: str) -> str:
    """
    STRICT normalization to: "Target comp: $XXK–$YYK OTE"

    Extracts all dollar amounts and standardizes to OTE format.
    """
    if not raw_text:
        return ""

    # Extract all dollar amounts with units (K, M, B)
    pattern = r'\$?(\d+(?:,\d{3})*(?:\.\d+)?)\s*([kKmMbB])?'
    matches = re.findall(pattern, raw_text)

    if not matches:
        # No parseable amounts - return prefixed original
        return f"Target comp: {raw_text}"

    # Parse amounts to dollars
    amounts = []
    for num_str, unit in matches:
        num = float(num_str.replace(',', ''))
        multiplier_map = {'k': 1_000, 'm': 1_000_000, 'b': 1_000_000_000}
        if unit:
            num *= multiplier_map.get(unit.lower(), 1)
        amounts.append(int(num))

    # Format based on number of amounts found
    if len(amounts) >= 2:
        low = min(amounts)
        high = max(amounts)
        return f"Target comp: ${low//1000}K–${high//1000}K OTE"
    elif amounts:
        return f"Target comp: ${amounts[0]//1000}K OTE"
    else:
        return f"Target comp: {raw_text}"
```

---

### 9. Availability

**Risk Level**: 🟢 **LOW**

**Problem**: Exact start dates combined with other data can identify candidates

**Solution**: Approximate timeframes only

#### Availability Formatting

| Raw Input | Formatted Output |
|-----------|------------------|
| January 15, 2025 | Available in January |
| 2 weeks notice | Available in 2 weeks |
| Immediately | Available immediately |
| Q1 2025 | Available Q1 2025 |
| After bonus payout in March | Available in March |
| Once replacement found (2-3 months) | Available in 2-3 months |

#### Implementation

```python
# Location: app/jobs/talentwell_curator.py:836-882

def _format_availability(self, raw_text: str) -> str:
    """Format availability text consistently."""
    if not raw_text:
        return ""

    # Clean up duplicate "Available"
    text = re.sub(r'\b(available)\s+\1\b', r'\1', raw_text, flags=re.IGNORECASE)

    text_lower = text.lower()

    if 'immediate' in text_lower or 'now' in text_lower or 'asap' in text_lower:
        return "Available immediately"

    # Extract timeframe: "X weeks/months"
    time_pattern = r'(\d+)\s*(weeks?|months?|days?)'
    match = re.search(time_pattern, text_lower)

    if match:
        number = match.group(1)
        unit = match.group(2)
        # Normalize unit to singular/plural
        if number == '1':
            unit = unit.rstrip('s')
        elif not unit.endswith('s'):
            unit = unit + 's'
        return f"Available in {number} {unit}"

    # Check for specific dates
    months = ['january', 'february', 'march', 'april', 'may', 'june',
             'july', 'august', 'september', 'october', 'november', 'december']
    for month in months:
        if month in text_lower:
            return f"Available in {month.capitalize()}"

    # Default formatting
    if text_lower.startswith('available'):
        return text
    else:
        return f"Available {text}"
```

---

## Implementation Architecture

### System Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    VAULT ALERTS GENERATION PIPELINE              │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  AGENT 1: Database Loader                                       │
│  - Query vault_candidates table (PostgreSQL)                    │
│  - Filter by audience (advisors vs executives)                  │
│  - Load raw candidate data                                      │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  AGENT 2: GPT-5 Bullet Generator (with Redis caching)          │
│  - Generate 5-6 compelling bullets per candidate                │
│  - Cache key: vault:bullets:{TWAV_NUMBER}                       │
│  - 24-hour TTL                                                  │
│  - 90% cache hit rate in production                             │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  🔒 PRIVACY MODE CHECKPOINT (PRIVACY_MODE=true)                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  1. Firm Anonymization                                   │  │
│  │     _anonymize_company(firm, aum)                        │  │
│  │     - Check FIRM_TYPE_MAP for wirehouse/RIA/bank        │  │
│  │     - Apply AUM-based refinement for RIAs               │  │
│  │     - Fallback: "Advisory firm"                         │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  2. AUM Rounding                                         │  │
│  │     _round_aum_for_privacy(aum_value)                    │  │
│  │     - $1B+: Round to billions                           │  │
│  │     - $100M-$999M: Round to hundreds of millions        │  │
│  │     - <$100M: Suppress (too identifying)                │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  3. Location Normalization                               │  │
│  │     _normalize_location(location)                        │  │
│  │     - Use city_context.json mapping                     │  │
│  │     - Top 25 metros only                                │  │
│  │     - Small cities: Add regional context                │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  4. Compensation Standardization                         │  │
│  │     _standardize_compensation(raw_text)                  │  │
│  │     - Parse all dollar amounts                          │  │
│  │     - Format: "Target comp: $XXK–$YYK OTE"             │  │
│  │     - Handle M/K/B suffixes                             │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  5. Availability Formatting                              │  │
│  │     _format_availability(raw_text)                       │  │
│  │     - Remove exact dates                                │  │
│  │     - Use month names or week counts                    │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  6. Internal Note Filtering                              │  │
│  │     _is_internal_note(text)                              │  │
│  │     - Suppress "TBD", "unclear", "depending on"         │  │
│  │     - Remove recruiter-only commentary                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  AGENT 3: HTML Renderer (Boss's Exact Format)                  │
│  - Apply print-optimized CSS                                    │
│  - page-break-inside: avoid (prevents card splitting)           │
│  - Render two reports: advisors + executives                    │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  AGENT 4: Quality Verifier                                      │
│  - Check 5-6 bullets per card                                   │
│  - Validate TWAV reference codes                                │
│  - Ensure location fields populated                             │
│  - Generate compliance metrics                                  │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  OUTPUT: boss_format_advisors_TIMESTAMP.html                    │
│          boss_format_executives_TIMESTAMP.html                  │
└─────────────────────────────────────────────────────────────────┘
```

### Key Components

#### 1. LangGraph Workflow
**File**: `/home/romiteld/Development/Desktop_Apps/outlook/generate_boss_format_langgraph.py`

```python
class VaultAlertsState(TypedDict):
    all_candidates: List[Dict]
    advisor_candidates: List[Dict]
    executive_candidates: List[Dict]
    cache_manager: Optional[RedisCacheManager]
    cache_stats: Dict[str, int]
    quality_metrics: Dict[str, Any]
    advisor_html: Optional[str]
    executive_html: Optional[str]
    errors: List[str]
```

**Workflow Sequence**:
1. `agent_database_loader` → Load from PostgreSQL
2. `agent_bullet_generator` → GPT-5 bullet generation with Redis caching
3. `agent_html_renderer` → Privacy-aware HTML rendering
4. `agent_quality_verifier` → Compliance checks

#### 2. TalentWell Curator (Weekly Digests)
**File**: `/home/romiteld/Development/Desktop_Apps/outlook/app/jobs/talentwell_curator.py`

**Privacy Integration Points**:
- Line 126-134: `FIRM_TYPE_MAP` dictionary
- Line 651-688: `_anonymize_company()` method
- Line 722-738: `_round_aum_for_privacy()` method
- Line 1650-1675: `_normalize_location()` method
- Line 740-794: `_standardize_compensation()` method

**Feature Flag**:
```python
from app.config import PRIVACY_MODE

if PRIVACY_MODE:
    display_company = self._anonymize_company(company, parsed_aum)
else:
    display_company = company
```

#### 3. Vault Alerts Generator (Reusable Module)
**File**: `/home/romiteld/Development/Desktop_Apps/outlook/app/jobs/vault_alerts_generator.py`

**Custom Filtering Support**:
```python
generator = VaultAlertsGenerator()
result = await generator.generate_alerts(
    custom_filters={
        "locations": ["New York, NY", "Chicago, IL"],
        "designations": ["CFA", "CFP"],
        "availability": "Immediately",
        "compensation_min": 150000,
        "compensation_max": 250000,
        "date_range_days": 30
    },
    max_candidates=50
)
```

---

## Compliance Verification

### Automated Verification Script

**File**: Create `/home/romiteld/Development/Desktop_Apps/outlook/scripts/verify_anonymization.py`

```python
#!/usr/bin/env python3
"""
Vault Alerts Anonymization Compliance Verifier

Scans generated HTML files for anonymization violations.
Returns exit code 1 if any violations found.
"""

import re
import sys
from pathlib import Path
from typing import List, Tuple

# Known firm names that should be anonymized
PROHIBITED_FIRMS = [
    'Merrill Lynch', 'Morgan Stanley', 'Wells Fargo', 'UBS', 'Raymond James',
    'Fisher Investments', 'Edelman Financial', 'JPMorgan', 'Bank of America',
    'Northwestern Mutual', 'MassMutual', 'New York Life', 'Prudential',
    'Deloitte', 'PwC', 'EY', 'KPMG', 'McKinsey', 'BCG', 'Bain'
]

# Specific award/program names that should be generalized
PROHIBITED_AWARDS = [
    "President's Club", "Chairman's Club", "Barron's Top", "Forbes Best",
    "PBIG", "Thunder Program", "Wealth Academy"
]

# Patterns that indicate insufficient anonymization
SUSPICIOUS_PATTERNS = [
    (r'\$\d+,\d+,\d+\.\d{2}', 'Exact dollar amount (should be rounded)'),
    (r'\b(MBA|Bachelor|Master).*\b(Harvard|Wharton|Stanford|MIT|Yale)\b', 'School name in education'),
    (r'\b\d{4}\b.*\b(graduated|class of|passed)\b', 'Graduation year mentioned'),
    (r'#\d+\s+(producer|advisor|performer)\s+at\s+\w+', 'Specific ranking at firm'),
]

def check_html_file(file_path: Path) -> List[Tuple[str, int, str]]:
    """
    Check HTML file for anonymization violations.

    Returns:
        List of (violation_type, line_number, context) tuples
    """
    violations = []

    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
        lines = content.split('\n')

    # Check for prohibited firm names
    for firm in PROHIBITED_FIRMS:
        if firm.lower() in content.lower():
            for line_num, line in enumerate(lines, 1):
                if firm.lower() in line.lower():
                    violations.append((
                        f'FIRM_NAME: {firm}',
                        line_num,
                        line.strip()[:100]
                    ))

    # Check for prohibited awards/programs
    for award in PROHIBITED_AWARDS:
        if award.lower() in content.lower():
            for line_num, line in enumerate(lines, 1):
                if award.lower() in line.lower():
                    violations.append((
                        f'AWARD_NAME: {award}',
                        line_num,
                        line.strip()[:100]
                    ))

    # Check suspicious patterns
    for pattern, description in SUSPICIOUS_PATTERNS:
        matches = re.finditer(pattern, content, re.IGNORECASE)
        for match in matches:
            # Find line number
            line_num = content[:match.start()].count('\n') + 1
            violations.append((
                f'PATTERN: {description}',
                line_num,
                lines[line_num - 1].strip()[:100]
            ))

    return violations

def verify_anonymization_compliance(html_files: List[Path]) -> int:
    """
    Verify anonymization compliance across multiple HTML files.

    Returns:
        Exit code (0 = pass, 1 = violations found)
    """
    total_violations = 0

    for file_path in html_files:
        print(f"\n{'='*80}")
        print(f"Checking: {file_path.name}")
        print(f"{'='*80}")

        violations = check_html_file(file_path)

        if violations:
            print(f"\n❌ VIOLATIONS FOUND: {len(violations)}")
            for violation_type, line_num, context in violations:
                print(f"\n  Line {line_num}: {violation_type}")
                print(f"  Context: {context}")
            total_violations += len(violations)
        else:
            print("\n✅ PASS: No violations detected")

    print(f"\n{'='*80}")
    print(f"SUMMARY: {total_violations} total violations across {len(html_files)} files")
    print(f"{'='*80}\n")

    return 1 if total_violations > 0 else 0

if __name__ == '__main__':
    # Find all boss_format HTML files in current directory
    html_files = list(Path('.').glob('boss_format_*.html'))

    if not html_files:
        print("No vault alert HTML files found.")
        sys.exit(0)

    exit_code = verify_anonymization_compliance(html_files)
    sys.exit(exit_code)
```

**Usage**:
```bash
# Run verification on generated HTML files
python scripts/verify_anonymization.py

# Exit code 0 = pass, 1 = violations found
```

### Manual Review Checklist

Before releasing vault alerts to clients:

- [ ] **Firm Names**: No specific firm names visible (search for "Merrill", "Morgan", "UBS")
- [ ] **AUM Values**: All rounded to ranges with "+" suffix (no exact $X,XXX,XXX.XX)
- [ ] **Locations**: Only major metros, no small cities without regional context
- [ ] **Education**: No school names or graduation years
- [ ] **Awards**: No specific award names ("President's Club", "Barron's Top 100")
- [ ] **Compensation**: All formatted as "Target comp: $XXK–$YYK OTE"
- [ ] **Licenses**: No dates or jurisdictions ("Series 7 obtained 2015" → "Series 7")
- [ ] **Internal Notes**: No "TBD", "unclear", "depending on" language
- [ ] **Availability**: No exact dates ("January 15" → "Available in January")
- [ ] **Reference Codes**: TWAV codes present for internal tracking

### Expected Compliance Score

**Target**: 95%+ confidentiality protection

**Calculation**:
```
Compliance Score = 100% - (Violations / Total Candidate Cards × 100%)
```

**Acceptable Thresholds**:
- **95-100%**: Production-ready ✅
- **90-94%**: Review violations, fix before release ⚠️
- **<90%**: Do not release, major privacy issues 🔴

---

## Testing

### Unit Tests

**File**: `/home/romiteld/Development/Desktop_Apps/outlook/tests/talentwell/test_privacy_integration.py`

#### Test Coverage

1. **Company Anonymization** (`test_full_digest_generation_with_privacy_mode`)
   - Verifies firm names replaced with generic types
   - Checks AUM-based refinement for RIAs
   - Validates fallback logic for unknown firms

2. **AUM Rounding** (`test_aum_privacy_rounding`)
   - Tests billion-range rounding ($6B → "$5B+")
   - Tests hundred-million ranges ($750M → "$500M+")
   - Tests suppression of <$100M values

3. **Compensation Formatting** (`test_compensation_parsing_edge_cases_with_privacy`)
   - Range parsing: "250k to 350k" → "$250K–$350K OTE"
   - Single value: "$500,000" → "$500K OTE"
   - Million suffix: "1.5M all-in" → "$1500K OTE"
   - Unparseable: "negotiable" → "Target comp: negotiable"

4. **Location Normalization**
   - Suburban consolidation (Jersey City → New York, NY)
   - Small city handling (Gulf Breeze → "Gulf Breeze (Pensacola area)")
   - Bay Area consolidation (Palo Alto → San Francisco, CA)

5. **Rollback Testing** (`test_privacy_mode_rollback_behavior`)
   - Verifies PRIVACY_MODE=false disables anonymization
   - Ensures location bullets re-enabled
   - Confirms original firm names displayed

### Integration Tests

**File**: `/home/romiteld/Development/Desktop_Apps/outlook/tests/test_vault_alerts_end_to_end.py`

```python
import pytest
from app.jobs.vault_alerts_generator import VaultAlertsGenerator

@pytest.mark.asyncio
async def test_full_vault_alerts_generation_with_privacy():
    """End-to-end test: Database → Anonymization → HTML output."""
    generator = VaultAlertsGenerator()

    result = await generator.generate_alerts(
        custom_filters=None,  # All candidates
        max_candidates=10,
        save_files=False
    )

    # Verify metadata
    assert result['metadata']['total_candidates'] > 0
    assert result['metadata']['cache_hit_rate'] >= 0.0

    # Parse HTML output
    advisor_html = result['advisor_html']

    # Verify no firm names leaked
    prohibited_firms = ['Merrill Lynch', 'Morgan Stanley', 'UBS', 'Wells Fargo']
    for firm in prohibited_firms:
        assert firm not in advisor_html, f"Firm name not anonymized: {firm}"

    # Verify generic replacements present
    assert 'Major wirehouse' in advisor_html or 'Large RIA' in advisor_html

    # Verify compensation formatting
    assert 'Target comp:' in advisor_html
    assert 'OTE' in advisor_html or 'Negotiable' in advisor_html

    # Verify reference codes present
    assert 'TWAV' in advisor_html
```

### Running Tests

```bash
# Run privacy-specific tests
pytest tests/talentwell/test_privacy_integration.py -v

# Run with coverage report
pytest tests/talentwell/test_privacy_integration.py --cov=app.jobs.talentwell_curator --cov-report=term-missing

# Run integration tests
pytest tests/test_vault_alerts_end_to_end.py -v

# Run all tests
pytest --cov=app --cov-report=html
```

---

## Deployment

### Pre-Deployment Checklist

Before deploying to production:

- [ ] All unit tests passing (`pytest tests/talentwell/test_privacy_integration.py`)
- [ ] Integration tests passing
- [ ] Verification script shows zero violations
- [ ] Boss approval obtained for sample HTML output
- [ ] Privacy mode enabled in production environment (`PRIVACY_MODE=true`)
- [ ] Redis cache cleared to force re-anonymization (`redis-cli FLUSHDB`)
- [ ] Sample alerts reviewed manually for quality
- [ ] Documentation updated with any new firm types
- [ ] Rollback plan documented

### Environment Configuration

**Production** (`/home/romiteld/Development/Desktop_Apps/outlook/.env.local`):
```bash
# Privacy Controls
PRIVACY_MODE=true
FEATURE_GROWTH_EXTRACTION=true
FEATURE_LLM_SENTIMENT=true

# Database
DATABASE_URL=postgresql://user:pass@host:5432/well_intake

# Redis Cache
AZURE_REDIS_CONNECTION_STRING=rediss://...

# Azure OpenAI (for bullet generation)
AZURE_OPENAI_KEY=...
AZURE_OPENAI_ENDPOINT=https://eastus2.api.cognitive.microsoft.com/
AZURE_OPENAI_DEPLOYMENT=gpt-5-mini
AZURE_OPENAI_API_VERSION=2024-08-01-preview
```

### Production Rollout Steps

1. **Stage 1: Validation** (Day 1)
   ```bash
   # Generate test batch
   python generate_boss_format_langgraph.py

   # Run verification
   python scripts/verify_anonymization.py

   # Manual review with boss
   ```

2. **Stage 2: Soft Launch** (Day 2-3)
   ```bash
   # Generate real alerts but don't distribute
   # Review with internal team
   # Verify all 146 vault candidates pass checks
   ```

3. **Stage 3: Limited Distribution** (Day 4-5)
   ```bash
   # Send to 3-5 trusted clients
   # Collect feedback
   # Monitor for identification attempts
   ```

4. **Stage 4: Full Production** (Day 6+)
   ```bash
   # Enable weekly scheduled generation
   # Monitor compliance metrics
   # Quarterly review of firm type mappings
   ```

### Rollback Procedure

If privacy violations discovered in production:

1. **Immediate Actions**:
   ```bash
   # Stop scheduled digest generation
   sudo systemctl stop vault-alerts-scheduler

   # Recall distributed alerts (email admins)
   # Disable Teams bot digest commands temporarily
   ```

2. **Investigation**:
   ```bash
   # Run verification on last 10 generated files
   python scripts/verify_anonymization.py boss_format_*.html

   # Check logs for anonymization errors
   az containerapp logs show --name well-intake-api --follow | grep "anonymize"
   ```

3. **Fix & Re-deploy**:
   ```bash
   # Fix anonymization logic
   # Re-run all tests
   # Clear Redis cache
   # Re-generate alerts
   ```

---

## Troubleshooting

### Common Issues

#### Issue 1: Firm Name Leaked in Output

**Symptom**: Verification script reports firm name violations

**Diagnosis**:
```bash
# Check if firm in FIRM_TYPE_MAP
python -c "from app.jobs.talentwell_curator import TalentWellCurator; print(TalentWellCurator.FIRM_TYPE_MAP)"
```

**Resolution**:
1. Add firm to `FIRM_TYPE_MAP` in `/home/romiteld/Development/Desktop_Apps/outlook/app/jobs/talentwell_curator.py`
2. Clear Redis cache: `redis-cli DEL vault:bullets:*`
3. Re-generate alerts

**Example Fix**:
```python
FIRM_TYPE_MAP = {
    'wirehouse': [
        'Merrill Lynch', 'Morgan Stanley', 'Wells Fargo', 'UBS', 'Raymond James',
        'LPL Financial',  # ← Add new firm here
    ],
    # ...
}
```

#### Issue 2: AUM Not Rounded Properly

**Symptom**: Exact AUM values visible (e.g., "$2,500,000,000")

**Diagnosis**:
```python
# Test AUM rounding function
from app.jobs.talentwell_curator import TalentWellCurator
curator = TalentWellCurator()
print(curator._round_aum_for_privacy(2_500_000_000))
# Expected: "$2B+ AUM"
```

**Resolution**:
- Check if `_round_aum_for_privacy()` called before bullet generation
- Verify PRIVACY_MODE enabled
- Check for direct AUM insertion bypassing anonymization

#### Issue 3: Location Not Normalized

**Symptom**: Small cities visible without regional context

**Diagnosis**:
```bash
# Check city_context.json mapping
cat app/policy/seed/city_context.json | grep -i "gulf_breeze"
```

**Resolution**:
1. Add missing city to `city_context.json`
2. Re-run location normalization
3. Clear cached bullets

**Example**:
```json
{
  "gulf_breeze_fl": "Gulf Breeze (Pensacola area)",
  "navarre_fl": "Pensacola, FL",
  "fort_walton_beach_fl": "Fort Walton Beach (Pensacola area)"
}
```

#### Issue 4: Compensation Format Inconsistent

**Symptom**: Various compensation formats in output

**Diagnosis**:
```python
# Test compensation parser
from app.jobs.talentwell_curator import TalentWellCurator
curator = TalentWellCurator()
print(curator._standardize_compensation("250k to 350k base + bonus"))
# Expected: "Target comp: $250K–$350K OTE"
```

**Resolution**:
- Update regex patterns in `_standardize_compensation()`
- Handle edge cases (M suffix, ranges, "all-in" phrasing)
- Add test cases for new patterns

#### Issue 5: Internal Notes Leaked

**Symptom**: "TBD", "unclear", "depending on" visible in bullets

**Diagnosis**:
```python
# Test internal note filter
from app.jobs.talentwell_curator import TalentWellCurator
curator = TalentWellCurator()
print(curator._is_internal_note("Availability: TBD depending on bonus payout"))
# Expected: True (should be filtered)
```

**Resolution**:
- Expand `internal_patterns` list in `_is_internal_note()`
- Apply filter before bullet ranking
- Re-generate affected alerts

---

## Maintenance

### Quarterly Review Tasks

**Q1, Q2, Q3, Q4 (Every 3 months)**:

1. **Update Firm Mappings**
   - Review new firms in vault_candidates table
   - Add to `FIRM_TYPE_MAP` as needed
   - Test with sample data

2. **Review Location Mappings**
   - Check for new cities in candidate data
   - Update `city_context.json`
   - Validate metro area consolidations

3. **Compliance Audit**
   - Run verification script on last 100 alerts
   - Manual review of random sample (10 alerts)
   - Document any violations found
   - Update rules as needed

4. **Performance Review**
   - Check Redis cache hit rates (target: >90%)
   - Review bullet generation latency
   - Optimize slow anonymization functions

### Adding New Firms

**Process**:

1. **Identify New Firm**:
   ```sql
   SELECT DISTINCT firm, COUNT(*) as count
   FROM vault_candidates
   WHERE firm NOT IN ('Major wirehouse', 'Large RIA', 'Mid-sized RIA', ...)
   ORDER BY count DESC;
   ```

2. **Classify Firm Type**:
   - Wirehouse (Merrill, Morgan, UBS, etc.)
   - RIA (independent advisory firm)
   - Bank (JPMorgan, Bank of America, etc.)
   - Insurance (Northwestern Mutual, MassMutual, etc.)
   - Law firm (LLP, PC suffixes)
   - Accounting (Big 4)
   - Consulting (McKinsey, BCG, Bain)

3. **Update Code**:
   ```python
   # File: app/jobs/talentwell_curator.py:126-134
   FIRM_TYPE_MAP = {
       'wirehouse': [
           'Merrill Lynch', 'Morgan Stanley', 'Wells Fargo', 'UBS', 'Raymond James',
           'NEW FIRM NAME HERE',  # ← Add here
       ],
       # ...
   }
   ```

4. **Test Changes**:
   ```bash
   pytest tests/talentwell/test_privacy_integration.py::TestPrivacyIntegration::test_full_digest_generation_with_privacy_mode -v
   ```

5. **Deploy**:
   ```bash
   git add app/jobs/talentwell_curator.py
   git commit -m "Add [NEW FIRM] to anonymization mappings"
   git push

   # Deploy to Azure Container Apps
   az containerapp update --name well-intake-api --resource-group TheWell-Infra-East \
     --image wellintakeacr0903.azurecr.io/well-intake-api:latest
   ```

### Updating Location Maps

**Process**:

1. **Identify New Locations**:
   ```sql
   SELECT DISTINCT city, state, COUNT(*) as count
   FROM vault_candidates
   WHERE city IS NOT NULL
   ORDER BY count DESC;
   ```

2. **Determine Metro Area**:
   - Use [U.S. Census Bureau MSA Definitions](https://www.census.gov/programs-surveys/metro-micro/about.html)
   - Consolidate to top 25 metros
   - Add regional context for small cities

3. **Update city_context.json**:
   ```json
   {
     "new_city_state": "Major Metro Area",
     "suburb_city_state": "Major Metro Area",
     "small_town_state": "Small Town (Regional Context)"
   }
   ```

4. **Test Normalization**:
   ```python
   from app.jobs.talentwell_curator import TalentWellCurator
   import asyncio

   async def test():
       curator = TalentWellCurator()
       result = await curator._normalize_location("New City, State")
       print(result)  # Should show normalized metro

   asyncio.run(test())
   ```

5. **Commit & Deploy**:
   ```bash
   git add app/policy/seed/city_context.json
   git commit -m "Add location mappings for [NEW CITIES]"
   ```

---

## Appendix

### Reference Documents

- **PRIVACY_MODE Feature Flag**: `/home/romiteld/Development/Desktop_Apps/outlook/app/config/feature_flags.py`
- **Firm Type Mappings**: `/home/romiteld/Development/Desktop_Apps/outlook/app/jobs/talentwell_curator.py:126-134`
- **City Context Mappings**: `/home/romiteld/Development/Desktop_Apps/outlook/app/policy/seed/city_context.json`
- **Privacy Integration Tests**: `/home/romiteld/Development/Desktop_Apps/outlook/tests/talentwell/test_privacy_integration.py`

### Compliance Standards

- **GDPR Article 5**: Data minimization principle
- **CCPA Section 1798.100**: Consumer right to know
- **Financial Industry Confidentiality**: FINRA Rule 2010 (Standards of Commercial Honor)

### Contact

**Questions or Issues**:
- Email: daniel.romitelli@emailthewell.com
- Teams: @Well Intake Development Team
- Documentation: This file (`ANONYMIZATION_RULES.md`)

---

**Document Status**: ✅ Approved for Production
**Next Review Date**: 2026-01-13 (Quarterly)
